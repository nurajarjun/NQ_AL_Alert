name: Deploy with Testing

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt || echo "Requirements install completed with warnings"
      
      - name: Test evening scalper message formatting
        run: |
          python test_evening_message.py
      
      - name: Verify critical files exist
        run: |
          test -f backend/main.py || exit 1
          test -f backend/analysis/evening_scalper.py || exit 1
          test -f Dockerfile || exit 1
          test -f docker-compose.yml || exit 1
          echo "âœ… All critical files present"

  deploy:
    name: Deploy to Oracle Cloud
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create backup before deployment
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh ${ORACLE_USER}@${ORACLE_HOST} << 'EOF'
            cd ~/NQ_AL_Alert
            
            # Create backup tag
            BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"
            docker tag nq-ai-alerts:latest nq-ai-alerts:${BACKUP_TAG} 2>/dev/null || echo "No existing image to backup"
            echo "Backup created: ${BACKUP_TAG}"
          EOF
      
      - name: Deploy to Oracle Cloud
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh ${ORACLE_USER}@${ORACLE_HOST} << 'EOF'
            cd ~/NQ_AL_Alert
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "âš™ï¸  Updating environment..."
            cat > .env << 'ENVEOF'
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
          AUTONOMOUS_MODE=true
          ALERT_THRESHOLD=70
          LOG_LEVEL=INFO
          PYTHONUNBUFFERED=1
          ENVEOF
            
            echo "ðŸ”„ Restarting containers..."
            docker-compose restart
            
            echo "â³ Waiting for startup..."
            sleep 15
            
            echo "ðŸ¥ Health check..."
            if curl -f http://localhost:8001/; then
              echo "âœ… Deployment successful!"
            else
              echo "âŒ Health check failed! Rolling back..."
              LATEST_BACKUP=$(docker images | grep "nq-ai-alerts.*backup" | head -1 | awk '{print $2}')
              if [ ! -z "$LATEST_BACKUP" ]; then
                docker-compose down
                docker tag nq-ai-alerts:${LATEST_BACKUP} nq-ai-alerts:latest
                docker-compose up -d
                echo "ðŸ”„ Rolled back to ${LATEST_BACKUP}"
              fi
              exit 1
            fi
          EOF
      
      - name: Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          curl -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.DEPLOY_TELEGRAM_CHAT }}" \
            -d "parse_mode=Markdown" \
            -d "text=âœ… *Deployment Successful!*%0A%0AðŸ“ ${COMMIT_MSG}%0Aâ° $(date '+%H:%M:%S')%0AðŸ”— [Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
      
      - name: Notify Failure
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.DEPLOY_TELEGRAM_CHAT }}" \
            -d "parse_mode=Markdown" \
            -d "text=âŒ *Deployment FAILED!*%0A%0ASystem rolled back to previous version.%0AðŸ”— [Check Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
