name: Complete Auto-Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-and-deploy:
    name: Setup Oracle Cloud & Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add Oracle host keys manually (ssh-keyscan fails due to firewall)
          echo "${{ secrets.ORACLE_HOST }} ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIwQWsRt1cC9w2dlTw3kyLI37/9TBBIcW5N8YOjQRD9X" >> ~/.ssh/known_hosts
          echo "${{ secrets.ORACLE_HOST }} ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCyMVYxqqeR9jyLh8bqVnjNXCvZ4h6hc88yZyYqF7T28RCY/MAfFqB4ZCNpTJnvWP0OaVupxT4CE5pdzEgTq8cmw3FZZY5NwCWgQMfvL0hYz5+oE8e3RDM0qVWZ919HvGhFqMDBElGCC3qfOQ8/TdQeUEEC5rLVuWbptaTxtP5QtR08e9QVzMr+q4sYfgHfw/CwtZtUtuGZrccPZb3Ie1mJb1aQQJow3Pv2J6tg2UZ9uJYv0ew+YHOUJ7YYM8LmbiWNoHC6JPnZ0tZBsJTN7e/iNCyONEbAHbCYQc7ukR1syS0CU1isQ9FdJCIdeugmE/gBirf7GZMI5VbKbVEzAWggsbeeCxg1Vg6rWNuXA77p72afzZ+idMM0BY4qmBmH1UeWsCW+dLSczwzRtY+3zXAsfA2ijU1UtyPx3aqBWKTY2lidN3/D4TdhIv38oLQ4afkNk2K3DUbFGPZzoC1BHpr1Cfs2eJXkSe3Dt1Xf71ZCqOiCY/obJGYsPFMJtJU+xzM=" >> ~/.ssh/known_hosts
          echo "${{ secrets.ORACLE_HOST }} ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBD2HRhdJVmQrgXBMh1+C+w4IWVW227DU2x8HQndA8seV4NOifTyw1vhnnRq9JyA4e+TledLIOMkOcr4E8CFTwGs=" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # Configure SSH to keep connection alive
          cat >> ~/.ssh/config << 'EOF'
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF
      
      - name: Test SSH Connection
        id: test_ssh
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          echo "Testing SSH connection..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if ssh -o ConnectTimeout=10 -o ServerAliveInterval=60 ${ORACLE_USER}@${ORACLE_HOST} "echo 'SSH connection successful'"; then
              echo "âœ… SSH connection established"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "âš ï¸  SSH connection failed (attempt $RETRY_COUNT/$MAX_RETRIES)"
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              WAIT_TIME=$((RETRY_COUNT * 10))
              echo "Waiting ${WAIT_TIME}s before retry..."
              sleep $WAIT_TIME
            fi
          done
          
          echo "âŒ SSH connection failed after $MAX_RETRIES attempts"
          echo "Please check Oracle Cloud instance status and SSH configuration"
          exit 1
      
      - name: Check if Docker is installed
        id: check_docker
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          DOCKER_INSTALLED=$(ssh ${ORACLE_USER}@${ORACLE_HOST} "command -v docker &> /dev/null && echo 'true' || echo 'false'")
          echo "docker_installed=${DOCKER_INSTALLED}" >> $GITHUB_OUTPUT
      
      - name: Run automated setup (first time only)
        if: steps.check_docker.outputs.docker_installed == 'false'
        timeout-minutes: 60
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          # Copy setup script to Oracle Cloud
          scp -o ServerAliveInterval=60 setup-oracle.sh ${ORACLE_USER}@${ORACLE_HOST}:~/
          
          # Run setup script with keep-alive
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=120 ${ORACLE_USER}@${ORACLE_HOST} << 'EOF'
            chmod +x ~/setup-oracle.sh
            ~/setup-oracle.sh
            
            echo "Setup complete. Docker group applied."
          EOF
      
      - name: Deploy or Update
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=120 ${ORACLE_USER}@${ORACLE_HOST} << 'EOF'
            # Navigate to project
            cd ~/NQ_AL_Alert || {
              echo "Repository not found, cloning..."
              cd ~
              git clone https://github.com/nurajarjun/NQ_AL_Alert.git
              cd NQ_AL_Alert
            }
            
            # Discard any local changes and pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            # Update .env file
            echo "âš™ï¸  Updating environment variables..."
            cat > .env << 'ENVEOF'
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
          AUTONOMOUS_MODE=true
          ALERT_THRESHOLD=70
          LOG_LEVEL=INFO
          PYTHONUNBUFFERED=1
          ENVEOF
            
            # Check if containers exist
            if sudo docker-compose ps | grep -q "nq-ai-alerts"; then
              echo "ðŸ”„ Restarting existing containers..."
              sudo docker-compose restart
            else
              echo "ðŸ—ï¸  Building and starting containers..."
              sudo docker-compose build
              sudo docker-compose up -d
            fi
            
            # Wait for startup
            echo "â³ Waiting for startup..."
            sleep 15
            
            # Health check with retries
            echo "ðŸ¥ Running health check..."
            HEALTH_CHECK_RETRIES=3
            HEALTH_CHECK_PASSED=false
            
            for i in $(seq 1 $HEALTH_CHECK_RETRIES); do
              if curl -f http://localhost:8001/; then
                echo "âœ… Health check passed!"
                HEALTH_CHECK_PASSED=true
                break
              fi
              echo "âš ï¸  Health check attempt $i/$HEALTH_CHECK_RETRIES failed"
              if [ $i -lt $HEALTH_CHECK_RETRIES ]; then
                echo "Waiting 30s before retry..."
                sleep 30
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "âš ï¸  Health check failed, checking container status..."
              if sudo docker-compose ps | grep -q "Up"; then
                echo "âœ… Container is running, deployment considered successful"
                sudo docker-compose logs --tail=50
              else
                echo "âŒ Container is not running, deployment failed"
                sudo docker-compose logs --tail=100
                exit 1
              fi
            fi
          EOF
      
      - name: Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          curl -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.DEPLOY_TELEGRAM_CHAT }}" \
            -d "parse_mode=Markdown" \
            -d "text=âœ… *Auto-Deploy Successful!*%0A%0AðŸ“ ${COMMIT_MSG}%0AðŸŒ Oracle Cloud: ${{ secrets.ORACLE_HOST }}%0Aâ° $(date '+%H:%M:%S')%0AðŸ”— [Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
      
      - name: Notify Failure
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.DEPLOY_TELEGRAM_CHAT }}" \
            -d "parse_mode=Markdown" \
            -d "text=âŒ *Auto-Deploy FAILED!*%0A%0AðŸŒ Oracle Cloud: ${{ secrets.ORACLE_HOST }}%0AðŸ”— [Check Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
