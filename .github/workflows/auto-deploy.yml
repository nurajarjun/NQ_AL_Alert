name: Complete Auto-Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-and-deploy:
    name: Setup Oracle Cloud & Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
          
          # Configure SSH to keep connection alive
          cat >> ~/.ssh/config << 'EOF'
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF
      
      - name: Check if Docker is installed
        id: check_docker
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          DOCKER_INSTALLED=$(ssh ${ORACLE_USER}@${ORACLE_HOST} "command -v docker &> /dev/null && echo 'true' || echo 'false'")
          echo "docker_installed=${DOCKER_INSTALLED}" >> $GITHUB_OUTPUT
      
      - name: Run automated setup (first time only)
        if: steps.check_docker.outputs.docker_installed == 'false'
        timeout-minutes: 30
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          # Copy setup script to Oracle Cloud
          scp -o ServerAliveInterval=60 setup-oracle.sh ${ORACLE_USER}@${ORACLE_HOST}:~/
          
          # Run setup script with keep-alive
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=120 ${ORACLE_USER}@${ORACLE_HOST} << 'EOF'
            chmod +x ~/setup-oracle.sh
            ~/setup-oracle.sh
            
            echo "Setup complete. Docker group applied."
          EOF
      
      - name: Deploy or Update
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh ${ORACLE_USER}@${ORACLE_HOST} << 'EOF'
            # Navigate to project
            cd ~/NQ_AL_Alert || {
              echo "Repository not found, cloning..."
              cd ~
              git clone https://github.com/nurajarjun/NQ_AL_Alert.git
              cd NQ_AL_Alert
            }
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            # Update .env file
            echo "âš™ï¸  Updating environment variables..."
            cat > .env << 'ENVEOF'
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
          AUTONOMOUS_MODE=true
          ALERT_THRESHOLD=70
          LOG_LEVEL=INFO
          PYTHONUNBUFFERED=1
          ENVEOF
            
            # Check if containers exist
            if sudo docker-compose ps | grep -q "nq-ai-alerts"; then
              echo "ðŸ”„ Restarting existing containers..."
              sudo docker-compose restart
            else
              echo "ðŸ—ï¸  Building and starting containers..."
              sudo docker-compose build
              sudo docker-compose up -d
            fi
            
            # Wait for startup
            echo "â³ Waiting for startup..."
            sleep 15
            
            # Health check
            echo "ðŸ¥ Running health check..."
            if curl -f http://localhost:8001/; then
              echo "âœ… Deployment successful!"
            else
              echo "âš ï¸  Health check failed!"
              sudo docker-compose logs --tail=50
              exit 1
            fi
          EOF
      
      - name: Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          curl -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.DEPLOY_TELEGRAM_CHAT }}" \
            -d "parse_mode=Markdown" \
            -d "text=âœ… *Auto-Deploy Successful!*%0A%0AðŸ“ ${COMMIT_MSG}%0AðŸŒ Oracle Cloud: ${{ secrets.ORACLE_HOST }}%0Aâ° $(date '+%H:%M:%S')%0AðŸ”— [Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
      
      - name: Notify Failure
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.DEPLOY_TELEGRAM_CHAT }}" \
            -d "parse_mode=Markdown" \
            -d "text=âŒ *Auto-Deploy FAILED!*%0A%0AðŸŒ Oracle Cloud: ${{ secrets.ORACLE_HOST }}%0AðŸ”— [Check Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
