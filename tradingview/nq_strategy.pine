//@version=5
strategy("NQ AI Alert System", overlay=true, default_qty_type=strategy.fixed, default_qty_value=1)

// ============================================
// INPUTS
// ============================================
emaFast = input.int(9, "Fast EMA", minval=1)
emaSlow = input.int(21, "Slow EMA", minval=1)
atrPeriod = input.int(14, "ATR Period", minval=1)
rsiPeriod = input.int(14, "RSI Period", minval=1)
volumePeriod = input.int(20, "Volume MA Period", minval=1)
atrMultiplier = input.float(2.0, "ATR Multiplier for Stop Loss", minval=0.5, step=0.5)
rrRatio1 = input.float(2.0, "Risk/Reward Ratio 1", minval=1.0, step=0.5)
rrRatio2 = input.float(4.0, "Risk/Reward Ratio 2", minval=1.0, step=0.5)

// Webhook URL (configure in alert settings)
webhookUrl = input.string("", "Webhook URL", tooltip="Your server webhook URL")

// ============================================
// INDICATORS
// ============================================
ema9 = ta.ema(close, emaFast)
ema21 = ta.ema(close, emaSlow)
atr = ta.atr(atrPeriod)
rsi = ta.rsi(close, rsiPeriod)
volumeMA = ta.sma(volume, volumePeriod)
volumeRatio = volume / volumeMA

// ============================================
// TREND DETECTION
// ============================================
uptrend = ema9 > ema21 and close > ema9
downtrend = ema9 < ema21 and close < ema9

// Additional trend confirmation
trendStrength = math.abs(ema9 - ema21) / atr
strongTrend = trendStrength > 1.5

// ============================================
// VOLUME CONFIRMATION
// ============================================
strongVolume = volumeRatio > 1.2
veryStrongVolume = volumeRatio > 1.5

// ============================================
// RSI FILTERS
// ============================================
rsiOversold = rsi < 30
rsiOverbought = rsi > 70
rsiNeutral = rsi > 40 and rsi < 70

// ============================================
// LONG SETUP CONDITIONS
// ============================================
longCondition = uptrend and strongTrend and rsiNeutral and strongVolume

// Calculate long trade parameters
longEntry = close
longStop = longEntry - (atr * atrMultiplier)
longRisk = longEntry - longStop
longTarget1 = longEntry + (longRisk * rrRatio1)
longTarget2 = longEntry + (longRisk * rrRatio2)

// ============================================
// SHORT SETUP CONDITIONS
// ============================================
shortCondition = downtrend and strongTrend and rsiNeutral and strongVolume

// Calculate short trade parameters
shortEntry = close
shortStop = shortEntry + (atr * atrMultiplier)
shortRisk = shortStop - shortEntry
shortTarget1 = shortEntry - (shortRisk * rrRatio1)
shortTarget2 = shortEntry - (shortRisk * rrRatio2)

// ============================================
// ALERTS
// ============================================

// Long Alert
if (longCondition)
    alertMessage = '{"direction":"LONG","entry":' + str.tostring(longEntry) + 
                   ',"stop":' + str.tostring(longStop) + 
                   ',"target1":' + str.tostring(longTarget1) + 
                   ',"target2":' + str.tostring(longTarget2) + 
                   ',"rsi":' + str.tostring(rsi) + 
                   ',"atr":' + str.tostring(atr) + 
                   ',"volume_ratio":' + str.tostring(volumeRatio) + '}'
    
    alert(alertMessage, alert.freq_once_per_bar)
    
    // Visual marker
    label.new(bar_index, low, "LONG\n" + str.tostring(longEntry, "#.##"), 
              style=label.style_label_up, color=color.new(color.green, 0), 
              textcolor=color.white, size=size.small)

// Short Alert
if (shortCondition)
    alertMessage = '{"direction":"SHORT","entry":' + str.tostring(shortEntry) + 
                   ',"stop":' + str.tostring(shortStop) + 
                   ',"target1":' + str.tostring(shortTarget1) + 
                   ',"target2":' + str.tostring(shortTarget2) + 
                   ',"rsi":' + str.tostring(rsi) + 
                   ',"atr":' + str.tostring(atr) + 
                   ',"volume_ratio":' + str.tostring(volumeRatio) + '}'
    
    alert(alertMessage, alert.freq_once_per_bar)
    
    // Visual marker
    label.new(bar_index, high, "SHORT\n" + str.tostring(shortEntry, "#.##"), 
              style=label.style_label_down, color=color.new(color.red, 0), 
              textcolor=color.white, size=size.small)

// ============================================
// PLOTTING
// ============================================
plot(ema9, "EMA 9", color=color.blue, linewidth=2)
plot(ema21, "EMA 21", color=color.red, linewidth=2)

// Background color for trend
bgcolor(uptrend ? color.new(color.green, 95) : downtrend ? color.new(color.red, 95) : na)

// Plot volume ratio as histogram
hline(1.2, "Volume Threshold", color=color.gray, linestyle=hline.style_dashed)

// ============================================
// STRATEGY EXECUTION (for backtesting)
// ============================================
if (longCondition)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long TP1", "Long", limit=longTarget1, stop=longStop, qty_percent=50)
    strategy.exit("Long TP2", "Long", limit=longTarget2, stop=longStop)

if (shortCondition)
    strategy.entry("Short", strategy.short)
    strategy.exit("Short TP1", "Short", limit=shortTarget1, stop=shortStop, qty_percent=50)
    strategy.exit("Short TP2", "Short", limit=shortTarget2, stop=shortStop)

// ============================================
// INFORMATION TABLE
// ============================================
var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Indicator", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 1, "Trend", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, uptrend ? "UP ↑" : downtrend ? "DOWN ↓" : "NEUTRAL", 
               text_color=uptrend ? color.green : downtrend ? color.red : color.gray, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "RSI", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(rsi, "#.#"), 
               text_color=rsiOverbought ? color.red : rsiOversold ? color.green : color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "ATR", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(atr, "#.#"), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "Volume", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(volumeRatio, "#.##") + "x", 
               text_color=strongVolume ? color.green : color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 5, "Setup", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, longCondition ? "LONG ✓" : shortCondition ? "SHORT ✓" : "WAIT", 
               text_color=longCondition or shortCondition ? color.yellow : color.gray, text_size=size.small)
